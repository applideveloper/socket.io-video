<body> 
        <video id='video' autoplay width="640" height="480"></video>
        <img src="" width="640" height="480" >
        <canvas style="display:none;" width="640" height="480"></canvas>
        <div id="wrapper"> 
            <button id="capture">capture</button>
            <button id="stop">stop</button>
        </div>
 
    </body>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
        var video = document.querySelector('video');
        var canvas = document.querySelector('canvas');
        var ctx = canvas.getContext('2d');
        var localMediaStream = null;
        var socket = io();
        var hasGetUserMedia = function() {
            return !!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
                navigator.mozGetUserMedia || navigator.msGetUserMedia);
        }
        var onFailSoHard = function(e) {
            console.log('エラー!', e);
        };
 
        var base64blob = function(_base64) {
          var i;
          var tmp = _base64.split(',');
          var data = atob(tmp[1]);
          var mime = tmp[0].split(':')[1].split(';')[0];
          var arr = new Uint8Array(data.length);
          for (i = 0; i < data.length; i++) {arr[i] = data.charCodeAt(i);}
          var blob = new Blob([arr], { type: mime });
          return blob;
        };
        var snapshot = function() {
            if (localMediaStream) {
                ctx.drawImage(video, 0, 0);
                var img = canvas.toDataURL('image/webp');
                var blob = base64blob(img);
                socket.emit("event", {blob:blob});
            }
        };
function ArrayBufferToBase64( buffer ) {
    var binary = ''
    var bytes = new Uint8Array( buffer )
    var len = bytes.byteLength;
    for (var i = 0; i < len; i++) {
        binary += String.fromCharCode( bytes[ i ] )
    }
    return window.btoa( binary );
}
        socket.on("event", function(data){
            var buf = ArrayBufferToBase64(data.blob);
          document.querySelector('img').src = 'data:image/png;base64,' + buf;
        });
        $('#video').on('timeupdate', function(e){
            snapshot();
        });
 
        if (hasGetUserMedia()) {
            console.log("カメラ OK");
        } else {
            alert("未対応ブラウザです。");
        }
 
 
        window.URL = window.URL || window.webkitURL;
        navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia ||
                                  navigator.mozGetUserMedia || navigator.msGetUserMedia;
 
        navigator.getUserMedia({video: true}, function(stream) {
            console.log(stream);
          video.src = window.URL.createObjectURL(stream);
          localMediaStream = stream;
          snapshot();
        }, onFailSoHard);
 
        //ボタンイベント
        $("#capture").click(function() {
            snapshot();
        });
        $("#stop").click(function() {
            localMediaStream.stop();
        });
        $("video").click(function() {
            snapshot();
        });
 
    </script>
